---
title: "Homework 3"
subtitle: <center> <h1>Simple Linear Regression Model Inference</h1> </center>
author: <center> < Jake Hiltscher > <center>
output: html_document
---

<style type="text/css">
h1.title {
  font-size: 40px;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
library(tidyverse)
library(ggfortify)
library(car)
```

## Data and Description

Climate change has left California particularly vulnerable to severe drought conditions. One factor affecting water availability in Southern California is stream runoff from snowfall (FYI: water in Utah is also heavily reliant on snowpack). If runoff could be predicted, engineers, planners, and policy makers could do their jobs more effectively because they would have an estimate as to how much water is entering the area. 

The Runoff water data set compares the **stream runoff (column 2)** (in acre-feet) of a river near Bishop, California (due east of San Jose) with **snowfall (column 1)** (in inches) at a site in the Sierra Nevada mountains. The data set contains 43 years' worth of measurements. Download the water.txt file from Canvas, and put it in the same folder as this R Markdown file.

#### 0. Replace the text "< PUT YOUR NAME HERE >" (above next to "author:") with your full name.

#### 1. Read in the data set, and call the tibble "water". Print a summary of the data and make sure the data makes sense. 

```{r}
water <- read.table("water.txt", header = TRUE)
head(water)
summary(water)
```

#### 2. Create (and print) a scatterplot of the data with variables on the appropriate axes. Make you plot look professional (make sure the plot is squre and the axes labels are descriptive). You should save your plot as an object to be used throughout the rest of the assignment.

```{r, fig.align='center'}
water_base_plot <- ggplot(data = water) +
  geom_point(mapping = aes(x = Precip, y = Runoff)) +
  theme(aspect.ratio = 1)
water_base_plot
```

#### 3. Calculate (and print) the correlation coefficient. Use that and the scatterplot to briefly describe the relationship between Stream Runoff and Snowfall.

```{r, fig.align='center'}
cor(x= water$Precip, y=water$Runoff)
```

There is a strong positive correlation between Stream Runoff and Snowfall.

#### 4. Add the OLS regression line to the scatterplot you created in 2. Print the plot.

```{r, fig.align='center'}
water_base_plot + 
  geom_smooth(mapping = aes(x = Precip, y = Runoff), 
              method = "lm", 
              se = FALSE) 
```

#### 5. Fit a simple linear regression model to the data (no transformations), and save the residuals and fitted values to the `water` dataframe. Print a summary of the linear model.

```{r}
water_lm <- lm(Runoff ~ Precip, data = water)
summary(water_lm)
water$residuals <- water_lm$residuals
water$fittedMPG <- water_lm$fitted.values
```

### Questions 6 to 11 involve using diagnostics to determine if the linear regression assumptions are met. For each assumption, (1) perform appropriate diagnostics to determine if the assumption is violated, and (2) explain whether or not you think the assumption is violated and why you think that. 

#### 6. (L) $X$ vs $Y$ is linear (use at least two diagnostic tools)

```{r, fig.align='center'}
water_base_plot

(water_resid_fitted_plot <- autoplot(water_lm, which = 1, ncol = 1, nrow = 1))
```

Not that linear, has a little curve to it.

#### 7. (I) The residuals are independent (no diagnostic tools - just think about how the data was collected and briefly write your thoughts)

The residuals are independent. The data was randomly sampled and the other factors/variables don't provide bias.

#### 8. (N) The residuals are normally distributed and centered at zero (use at least three diagnostic tools)

```{r, fig.align='center'}
water_hist <- ggplot(data = water) + 
  geom_histogram(mapping = aes(x = residuals, y = ..density..), 
                 binwidth = 2) +
  # stat_function() overlays the red normal curve on the histogram
  stat_function(fun = dnorm, 
                color = "red", 
                size = 2,
                args = list(mean = mean(water$residuals), 
                            sd = sd(water$residuals))) +
  theme(aspect.ratio = 1)

water_hist

(water_norm_plot <- autoplot(water_lm, which = 2, ncol = 1, nrow = 1))

shapiro.test(water$Runoff)
```

Residuals are normally distributed and centered at zero. The QQ plot shows the residuals equal around the slope.

#### 9. (E) The residuals have equal (constant) variance across all values of $X$ (homoscedastic) (use two diagnostic tools)

```{r, fig.align='center'}
water_resid_fitted_plot

grp <- as.factor(c(rep("lower", floor(dim(water)[1] / 2)), 
                   rep("upper", ceiling(dim(water)[1] / 2))))

leveneTest(unlist(water[order(water$Runoff), "residuals"]) ~ grp, 
           center = median)
```

The Residuals vs Fitted shows that residuals are skewed to the right. Meaning the residuals do not have equal constance

#### 10. (A) The model describes all observations (i.e., there are no influential points) (use at least four diagnostic tools)

```{r, fig.align='center'}
water_base_plot

water_hist

water_norm_plot

# calculate the DFFITS
water$dffits <- dffits(water_lm)

# plot the DFFITS against the observation number
ggplot(data = water) + 
  geom_point(mapping = aes(x = as.numeric(rownames(water)), 
                           y = abs(dffits))) +
  ylab("Absolute Value of DFFITS for Y") +
  xlab("Observation Number") +
  # for n > 30
  geom_hline(mapping = aes(yintercept = 2 * sqrt(length(water_lm$coefficients) /
                                                   length(dffits))),
             color = "red", 
             linetype = "dashed") +
  # for n <= 30 (code for future, small data sets)
  # geom_hline(mapping = aes(yintercept = 1),
  #            color = "red", 
  #            linetype = "dashed") +
  theme(aspect.ratio = 1)

# print a list of potential influential points according to DFFITS
# for n > 30
water %>% 
  mutate(rowNum = row.names(water)) %>%  # save original row numbers 
  # select potential influential pts
  filter(abs(dffits) > 2 * sqrt(length(water_lm$coefficients) / 
                                  length(dffits))) %>%
  arrange(desc(abs(dffits)))
```

Based on the DFFITS plot, there are 5 points that are influential points and effect the linear regression.

#### 11. (R) Additional predictor variables are not required (no diagnostic tools - just think about the variables you have and if there are other variables you think would help predict the response)

There are other variables that could help determine runoff, temperature is one that could effect the amount of runoff.


### Based on your answers to questions 6 through 11, you may (or may not) have decided a transformation to the data is needed. This was, hopefully, good practice for assessing model assumptions. For simplicity for this assignment, we will use the orignial model (no transformations) for the rest of the questions. While this may be less satisifying, it will save you time.:)

I would try some transformations on the Y-value first, then move on to the X-value if it doesn't work.


#### 12. Mathematically write out the fitted simple linear regression model for this data set using the coefficients you found above (do not use betas or matrix notation). Do not use "X" and "Y" in your model - use variable names that are fairly descriptive.

$\text{Runoff}_i)$ $=$ $\beta_0$ $+$ $\beta_1$$\text{Precip}_i$ $+$ $\epsilon_i$

#### 13. Compute, print, *and interpret* a 95% confidence interval for the slope.

```{r}
confint(water_lm, c("Precip"), level = 0.95)
```

We are 95% confident that the estimate slope for Runoff based on Precipitation is between 3316.809 and 4188.162.

#### 14. Based on the confidence interval, does an increase in snowfall *significantly* increase stream water? Why or why not?

An increase in snowfall significantly increases stream water. 

#### 15. Print a summary of the linear model. Interpret the results from the hypothesis test output for the slope.

```{r}
summary(water_lm)
```

The further the F-value is from 1, means there is more evidence to reject the null hypothesis.

#### 16. Briefly describe the difference between (1) a confidence interval for the slope, (2) a confidence interval for the mean of $Y$, and (3) a prediction interval for individual observations.

The confidence interval for the slope is about where the average/estimate slope is on a linear model with 95 confidence. The confidence interval for the MEAN is a 95% probability that the confidence interval captures the true best-fit line fo the population. A Predication interval for individual observations is creating an interval around the regression line that indicates the variability of the estimate of the values of Y at a specific X.

#### 17. Compute, print, *and interpret* a 95% confidence interval for the average of $Y$ when $x_i=30$.

```{r}
predict(water_lm,
        newdata = data.frame(Precip = 30),
        level = 0.95,
        interval = "confidence")
```

We are 95% confident that the average Runoff when there is 30 of Precipitation is between 131902.2 and 147276.1.

#### 18. Create a confidence band for the average of $Y$ across all values of $X$, and overlay this band (using a distinct color) on your previous scatterplot that you created in 4. Print the plot.

```{r}
 
precip_values <- seq(min(water$Precip), max(water$Precip), length = 100)
# 95% confidence intervals of **Runoff** across those values of Precip
conf_int_mean <- predict(water_lm, 
                               newdata = data.frame(Precip = precip_values), 
                               interval = "confidence",
                               level = 0.95)

# Store results in a data frame for plotting
preds <- data.frame("precip_values" = precip_values, 
                    conf_int_mean)

# Plot the predictions
water_base_plot + 
  geom_line(data = preds, 
            mapping = aes(x = precip_values, y = fit), 
            color = "blue", size = 1.5) + 
  geom_line(data = preds, 
            mapping = aes(x = precip_values, y = lwr), 
            color = "#d95f02", size = 1.5) +
  geom_line(data = preds, 
            mapping = aes(x = precip_values, y = upr), 
            color = "#d95f02", size = 1.5)
```

#### 19. Briefly explain why the confidence band is shaped the way that it is.

< your response here >

#### 20. Compute, print, *and interpret* a 95% prediction interval for $Y$ when $x_i=30$.

```{r}
predict(water_lm,
        newdata = data.frame(Precip = 30),
        level = 0.95,
        interval = "prediction")
```

We are 95% confident that the Runoff when there is 30 of Precipitation is between 119998.8 and 159179.5.

#### 21. Create a prediction band for $Y$ across all values of $X$, and overlay this band (using a distinct color) on your previous scatterplot that you created in 4. Print the plot.

```{r}
recip_values <- seq(min(water$Precip), max(water$Precip), length = 100)
# 95% confidence intervals of **Runoff** across those values of Precip
conf_int_mean <- predict(water_lm, 
                               newdata = data.frame(Precip = precip_values), 
                               interval = "prediction",
                               level = 0.95)
# Store results in a data frame for plotting
preds <- data.frame("precip_values" = precip_values, 
                    conf_int_mean)

# Plot the predictions
water_base_plot + 
  geom_line(data = preds, 
            mapping = aes(x = precip_values, y = fit), 
            color = "blue", size = 1.5) + 
  geom_line(data = preds, 
            mapping = aes(x = precip_values, y = lwr), 
            color = "#d95f02", size = 1.5) +
  geom_line(data = preds, 
            mapping = aes(x = precip_values, y = upr), 
            color = "#d95f02", size = 1.5)
```

#### 22. Briefly explain how/why the prediction band differs from the confidence band.

The predicition band is always bigger because the formula adds 1 to the cinterval from the beginning.

#### 23. What is the MSE (Mean Square Error) for the linear model you fit? Hint: you may refer to the ANOVA table results.

```{r}
anova <- aov(water_lm)  # get ANOVA components
water_anova <- summary(anova)[[1]]  # save data in a usable form

mse <- water_anova['Residuals','Mean Sq']
mse
```

#### 24. Briefly explain (1) what the MSE estimates and (2) a drawback to using it as a model evaluation metric.

MSE estimates the amount of spread in the residuals. One of the draw backs is that is lacks interpretability and also is highly influenced by outliers.

#### 25. Calculate the RMSE (Root Mean Square Error) for the linear model you fit. Print and interpret the result.

```{r}
rmse <- sqrt(mse)
rmse
```

#### 26. Calculate the MAE (Mean Absolute Error) for the linear model you fit (do not use a function from a random R package). Print and interpret the result.

```{r}

```

#### 27. Briefly explain a benefit of using the MAE as a model evaluation metric over the RMSE.

Turns everything positive and is more interpretable.

#### 28. Print a summary of the linear model. Briefly interpret the R-Squared (Coefficient of Determination) value.

```{r}
summary(water_lm)
```

R^2 shows the proportion of total variation in Y by the X values in the model. Higher the R^2, the better.

#### 29. Breifly interpret the Adjusted R-Squared (shown in the summary output above).

Adj. R^2 means the proportion of total variation in Y explained by the X values in the model, adjusted for the number of Betas in the model.

#### 30. Look at the F-Statistic and corresponding $p$-value from the summary of the linear model (output shown above). Do these values indicate that $X$ has a statistically significant linear association with $Y$?

The F-value and P-value indicate that $X$ has a statistically significant linear association.

#### 31. Briefly summarize what you learned, personally, from this analysis about the statistics, model fitting process, etc.

I learned the importance of P-value and F-value in showing that the slope is significant. It's starting to all make more sense and be more clear.

#### 32. Briefly summarize what you learned from this analysis *to a non-statistician*. Write a few sentences about (1) the purpose of this data set and analysis and (2) what you learned about this data set from your analysis. Write your response as if you were addressing a business manager (avoid using statistics jargon) and just provide the main take-aways.

The purpose of the data set and analysis was to apply testing to see if the data set was viable and the show realistic intervals where you could guess how much Runoff there would be based on the amount of Precipitation.

I learned that the amount of Runoff is highly influenced by the amount of Precipitation. The more precipitation, the more runoff there will be.
